import json
import random
from aiogram import Bot, Dispatcher, types, F
from aiogram.filters import Command
from aiogram.types import (
    InlineKeyboardButton, 
    InlineKeyboardMarkup, 
    ReplyKeyboardMarkup, 
    KeyboardButton,
)
from aiogram.utils.keyboard import InlineKeyboardBuilder
import asyncio
from pathlib import Path

# –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
BOT_TOKEN = '7535928499:AAH4IScZywy3uEf-G4zqWcfGIKoB7_BUKn8'

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()

# –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å–ª–æ–≤
def load_arabic_words():
    file_path = Path(__file__).parent / "arabic_words.json"
    with open(file_path, 'r', encoding='utf-8') as f:
        return json.load(f)

arabic_words = load_arabic_words()

# –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç—É—é reply-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–æ–π Start
def get_reply_keyboard():
    return ReplyKeyboardMarkup(keyboard=[[KeyboardButton(text="/start")]], resize_keyboard=True)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
@dp.message(Command("start"))
async def start(message: types.Message):
    builder = InlineKeyboardBuilder()
    
    builder.add(
        InlineKeyboardButton(text="–£—á–∏—Ç—å —Å–ª–æ–≤–æ üìñ", callback_data="get_word"),
        InlineKeyboardButton(text="–í–∏–∫—Ç–æ—Ä–∏–Ω–∞ üéØ", callback_data="quiz")
    )
    builder.adjust(2)
    
    welcome_text = f"–ê—Å—Å–∞–ª–∞–º—É –∞–ª–µ–π–∫—É–º! –Ø –ø–æ–º–æ–≥—É –≤–∞–º –∑–∞—É—á–∏–≤–∞—Ç—å –∞—Ä–∞–±—Å–∫–∏–µ —Å–ª–æ–≤–∞.\n–í –±–∞–∑–µ: {len(arabic_words)} —Å–ª–æ–≤\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
    
    await message.answer(
        welcome_text,
        reply_markup=builder.as_markup()
    )
    await message.answer(
        "–í—ã –≤—Å–µ–≥–¥–∞ –º–æ–∂–µ—Ç–µ –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –Ω–∞—á–∞–ª–æ, –Ω–∞–∂–∞–≤ /start",
        reply_markup=get_reply_keyboard()
    )

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è —Å–ª–æ–≤
@dp.callback_query(F.data == "get_word")
async def send_word(callback: types.CallbackQuery):
    word = random.choice(arabic_words)
    text = (
        f"<b>–ê—Ä–∞–±—Å–∫–æ–µ —Å–ª–æ–≤–æ:</b> {word['arabic']}\n"
        f"<b>–ü–µ—Ä–µ–≤–æ–¥:</b> {word['russian']}"
    )
    
    await callback.message.edit_text(
        text,
        parse_mode="HTML",
        reply_markup=InlineKeyboardMarkup(
            inline_keyboard=[[
                InlineKeyboardButton(text="–ï—â—ë —Å–ª–æ–≤–æ üîÑ", callback_data="get_word"),
                InlineKeyboardButton(text="–í–∏–∫—Ç–æ—Ä–∏–Ω–∞ üéØ", callback_data="quiz")
            ]]
        )
    )

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã
@dp.callback_query(F.data == "quiz")
async def start_quiz(callback: types.CallbackQuery):
    quiz_words = random.sample(arabic_words, 4)
    correct_word = random.choice(quiz_words)
    
    builder = InlineKeyboardBuilder()
    for word in quiz_words:
        builder.add(InlineKeyboardButton(
            text=word["russian"],
            callback_data=f"answer_{word['arabic']}_{correct_word['arabic']}"
        ))
    builder.adjust(2)
    
    await callback.message.edit_text(
        f"–ö–∞–∫ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—Å—è —Å–ª–æ–≤–æ <b>{correct_word['arabic']}</b>?",
        reply_markup=builder.as_markup(),
        parse_mode="HTML"
    )

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –º–µ–Ω—é
@dp.callback_query(F.data == "menu")
async def back_to_menu(callback: types.CallbackQuery):
    await start(callback.message)

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ –≤ –≤–∏–∫—Ç–æ—Ä–∏–Ω–µ
@dp.callback_query(F.data.startswith("answer_"))
async def check_answer(callback: types.CallbackQuery):
    _, selected_arabic, correct_arabic = callback.data.split('_')
    
    if selected_arabic == correct_arabic:
        await callback.answer("‚úÖ –í–µ—Ä–Ω–æ! –ú–æ–ª–æ–¥–µ—Ü!", show_alert=True)
    else:
        correct_translation = next(
            w["russian"] for w in arabic_words 
            if w["arabic"] == correct_arabic
        )
        await callback.answer(
            f"‚ùå –ù–µ–≤–µ—Ä–Ω–æ! –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: {correct_translation}",
            show_alert=True
        )

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
async def main():
    print(f"ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω —Å {len(arabic_words)} —Å–ª–æ–≤–∞–º–∏")
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
